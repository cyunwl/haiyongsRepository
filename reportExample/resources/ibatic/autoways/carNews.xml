<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="carNews">

 
 <select id="initDate" resultClass="java.util.HashMap">
	 Select to_char(min(c.FZDY6),'yyyy-MM-DD') Begindate,to_char(max(c.FZDY6),'yyyy-MM-DD') Enddate From cims_car_number c
</select>
 
 
<select id="findNewCarsInfo" resultClass="com.ways.app.carNews.model.carNewsDetail" parameterClass="java.util.Map">
select t.* from (
select a.*, rownum as rowIndex from (
select tab.*, count(1) over() totalCount from (
with bases as(
   Select distinct
   ccn.id id,
   ccn.parentid parentid,
   ccn.FZDY6,
   ccn.car_config_bm,  
   ccp.name pbrandName,
   ccp.name_eng pbrandNameEn,
   scs.scs scsName, 
   scs.scs_eng  scsNameEn,
   wg.grade_name_cn Segment,
   ccb.name brandchildName, 
   ccb.name_eng brandchildNameEn, 
   ccn.FZDY4 Typeid,
   ccn.ENGLISH_NAME typeideng, 
   ccn.sm smName,                         
   ccn.smeng smNameEn,
   ccnm.sm preSm,
   pch.lx ,   
   pch.lxeng,
   ccpl.pl, 
   cci.car_in as carIn,  
   cci.car_ineng as carInEn,
   ccc.sm,
   ccc.smeng
   ,ccpd.smeng as pd
   From cims_car_number ccn   
   Inner Join cims_car_brandchild ccb
   On ccb.id = ccn.fzdy2
   Inner Join cims_scs scs
   On scs.id = ccb.scs
   Inner Join cims_car_pbrand ccp
   On ccp.id = ccb.pbrandid
   Inner Join cims_car_brand ccbc
   On ccbc.id = ccb.parent_id
   Inner Join wias_info_grade wig
   On wig.brand_id = ccbc.id and wig.scs_id=scs.id
   Inner Join wias_grade wg
   On wg.grade_id = wig.grade_id
   Inner Join pms_car_hatchback pch
   On pch.id = ccn.hatchback
   Inner Join cims_car_pl ccpl
   On ccpl.id = ccn.pl
   Inner Join cims_car_pdfs ccpd
   On ccpd.id = ccn.pdfs
   inner join Cims_Car_in cci
   on ccn.car_in=cci.id
   inner join cims_car_change ccc
   on ccn.fzdy7=ccc.id
   left join cims_car_number ccnm
   on ccn.parentid=ccnm.id
  where 
   <isNotEmpty property="subModelId">
  		ccn.fzdy2  in ('$subModelId$') and 
   </isNotEmpty>
   <isNotEmpty property="bodyTypeId">
  	 pch.lxeng in( select lxeng from pms_car_hatchback where  id  in ('$bodyTypeId$')) and 
   </isNotEmpty>
  wig.group_id = '13' and ccn.FZDY6 Between to_date(Replace('$beginDate$','-',''),'YYYYMMDD') And to_date(Replace('$endDate$','-',''),'YYYYMMDD')
  ) 
  ,t1 as (
 select t.car_name id, t.direction_price from  (
   select  p.car_name id, max(p.MSRP_ADJUST_DATE) MSRP_ADJUST_DATE  
  FROM cims_direction_price p
  inner join  bases b
 on  p.car_name=b.id 
  group by p.car_name
  )  t1,cims_direction_price t where t.car_name=t1.id and t.msrp_adjust_date=t1.MSRP_ADJUST_DATE
)
  ,t11 as (
 select t.car_name id,  t.direction_price from  (
   select  p.car_name id, max(p.MSRP_ADJUST_DATE) MSRP_ADJUST_DATE  
  FROM cims_direction_price p
  inner join  bases b
 on  p.car_name=b.parentid
  group by p.car_name
  )  t1,cims_direction_price t where t.car_name=t1.id and t.msrp_adjust_date=t1.MSRP_ADJUST_DATE
 )
  
,t2 as (
 select t.car_config_id id,t1.fname || t1.ftype3 as driveType, 
 case when t.pzdyid=824 then 'FF'
 when  t.pzdyid=825 then 'FR'
 when  t.pzdyid=2030 then 'Real time 4WD'
 when  t.pzdyid=2029 then 'Part time 4WD'
 when  t.pzdyid=2028 then 'AWD' end
 as driveTypeEn    
 from cims_peizhi t,cims_pz_tree t1,bases b where t.car_config_id=b.id and t.pzdyid in ( 
 824
,825
,2029
,2028
,2030
) and ishave=1 and fvalue=1 and t.pzdyid=t1.id
)
 ,t3 as (
select t.car_config_id id,
max(case when t.pzdyid=743 then t.valuenote else '0' end) l,  
max(case when t.pzdyid=744 then t.valuenote else '0' end) w,    
max(case when t.pzdyid=745 then t.valuenote else '0' end) h ,  
max(case when t.pzdyid=746 then t.valuenote else '0' end) Wheelbase,  
max(case when t.pzdyid=768 then t.valuenote else '0' end) Kw,    
max(case when t.pzdyid=3359 then t.valuenote else '0' end) rpm,
max(case when t.pzdyid=769 then t.valuenote else '0' end) nm,    
max(case when t.pzdyid=3358 then t.valuenote else '0' end) erpm    
from cims_peizhi t,cims_pz_tree t1,bases b where t.car_config_id=b.id and t.pzdyid in ( 
746,768,3359,769,3358,743,744,745
) 
and ishave=1 and t.pzdyid=t1.id group by t.car_config_id
)
,t4 as (
 select t.car_config_id id,max(case when t.valuenote='-' then null else t.valuenote end)  valuenote
 from cims_peizhi t,cims_pz_tree t1,bases b
 where t.car_config_id=b.id and  t.pzdyid in (3361,3650) and ishave=1 and t.pzdyid=t1.id group by t.car_config_id
)
select 
b.id as id,
b.parentid as parentid,
to_char(b.FZDY6,'YYYY/MM/DD') as launchDate,
b.car_config_bm  as versionCode,
b.Segment as Segment,
b.scsName as manfName,
b.scsNameEn as manfNameEn,
b.pbrandName as brandName,
b.pbrandNameEn as brandNameEn,
b.pl as PL,
b.Typeid as trim,
b.typeideng as trimEn,
b.brandchildName as modelName,
b.brandchildNameEn as modelNameEn,
b.smName  as versionName,
b.smNameEn  as versionNameEn,
b.preSm as preVersionName, 
b.lx as bodyType,
b.lxeng as bodyTypeEn,
b.carIn as carIn,
b.carInEn as carInEn,
b.sm as changeDescription,
b.smeng as changeDescriptionEn,
t3.l ||'/'||t3.w||'/'||t3.h as LWH,
t3.Wheelbase as wheelbase,
t3.Kw||'/'||t3.rpm as maximumPower,
t3.nm||'/'||t3.erpm as maximumTorque
,case when SUBSTR(b.pl,0,3)=0 then '-' else ROUND(t3.Kw/SUBSTR(b.pl,0,3),1)||'' end as KWL
,t4.valuenote||b.pd  as transmission
,t2.driveType as driveType
,t2.driveTypeEn as driveTypeEn
,nvl(t1.direction_price||'','-') as MSRP
,nvl(t11.direction_price||'','-') as preMSRP
from bases b
left join t1 t1
on b.id=t1.id
left join t11 t11
on b.parentid=t11.id
left join t2 t2
on b.id=t2.id
left join t3 t3
on b.id=t3.id
left join t4 t4
on b.id=t4.id
)tab where 1=1
<isNotEmpty property="qlaunchDate" prepend="and">
	upper(tab.launchDate) like upper('%$qlaunchDate$%')
</isNotEmpty>
<isNotEmpty property="qversionCode" prepend="and">
	upper(tab.versionCode) like upper('%$qversionCode$%')
</isNotEmpty>
<isNotEmpty property="qbrandName" prepend="and">
	upper(tab.brandName) like upper('%$qbrandName$%')
</isNotEmpty>
<isNotEmpty property="qbrandNameEn" prepend="and">
	upper(tab.brandNameEn) like upper('%$qbrandNameEn$%')
</isNotEmpty>
<isNotEmpty property="qmanfName" prepend="and">
	upper(tab.manfName) like upper('%$qmanfName$%')
</isNotEmpty>
<isNotEmpty property="qmanfNameEn" prepend="and">
	upper(tab.manfNameEn) like upper('%$qmanfNameEn$%')
</isNotEmpty>
<isNotEmpty property="qsegment" prepend="and">
	upper(tab.segment) like upper('%$qsegment$%')
</isNotEmpty>
<isNotEmpty property="qmodelName" prepend="and">
	upper(tab.modelName) like upper('%$qmodelName$%')
</isNotEmpty>
<isNotEmpty property="qmodelNameEn" prepend="and">
	upper(tab.modelNameEn) like upper('%$qmodelNameEn$%')
</isNotEmpty>
<isNotEmpty property="qtrim" prepend="and">
	upper(tab.trim) like upper('%$qtrim$%')
</isNotEmpty>
<isNotEmpty property="qtrimEn" prepend="and">
	upper(tab.trimEn) like upper('%$qtrimEn$%')
</isNotEmpty>
<isNotEmpty property="qversionName" prepend="and">
	upper(tab.versionName) like upper('%$qversionName$%')
</isNotEmpty>
<isNotEmpty property="qversionNameEn" prepend="and">
	upper(tab.versionNameEn) like upper('%$qversionNameEn$%')
</isNotEmpty>
<isNotEmpty property="qMSRP" prepend="and">
	upper(tab.MSRP) like upper('%$qMSRP$%')
</isNotEmpty>
<isNotEmpty property="qpreVersionName" prepend="and">
	upper(tab.preVersionName) like upper('%$qpreVersionName$%')
</isNotEmpty>
<isNotEmpty property="qpreMSRP" prepend="and">
	upper(tab.preMSRP) like upper('%$qpreMSRP$%')
</isNotEmpty>
<isNotEmpty property="qbodyType" prepend="and">
	upper(tab.bodyType) like upper('%$qbodyType$%')
</isNotEmpty>
<isNotEmpty property="qbodyTypeEn" prepend="and">
	upper(tab.bodyTypeEn) like upper('%$qbodyTypeEn$%')
</isNotEmpty>
<isNotEmpty property="qdriveType" prepend="and">
	upper(tab.driveType) like upper('%$qdriveType$%')
</isNotEmpty>
<isNotEmpty property="qdriveTypeEn" prepend="and">
	upper(tab.driveTypeEn) like upper('%$qdriveTypeEn$%')
</isNotEmpty>
<isNotEmpty property="qcarIn" prepend="and">
	upper(tab.carIn) like upper('%$qcarIn$%')
</isNotEmpty>
<isNotEmpty property="qcarInEn" prepend="and">
	upper(tab.carInEn) like upper('%$qcarInEn$%')
</isNotEmpty>
<isNotEmpty property="qchangeDescription" prepend="and">
	upper(tab.changeDescription) like upper('%$qchangeDescription$%')
</isNotEmpty>
<isNotEmpty property="qchangeDescriptionEn" prepend="and">
	upper(tab.changeDescriptionEn) like upper('%$qchangeDescriptionEn$%')
</isNotEmpty>
<isNotEmpty property="qLWH" prepend="and">
	upper(tab.LWH) like upper('%$qLWH$%')
</isNotEmpty>
<isNotEmpty property="qwheelbase" prepend="and">
	upper(tab.wheelbase) like upper('%$qwheelbase$%')
</isNotEmpty>
<isNotEmpty property="qPL" prepend="and">
	upper(tab.PL) like upper('%$qPL$%')
</isNotEmpty>
<isNotEmpty property="qtransmission" prepend="and">
	upper(tab.transmission) like upper('%$qtransmission$%')
</isNotEmpty>
<isNotEmpty property="qmaximumPower" prepend="and">
	upper(tab.maximumPower) like upper('%$qmaximumPower$%')
</isNotEmpty>
<isNotEmpty property="qmaximumTorque" prepend="and">
	upper(tab.maximumTorque) like upper('%$qmaximumTorque$%')
</isNotEmpty>
<isNotEmpty property="qKWL" prepend="and">
	upper(tab.KWL) like upper('%$qKWL$%')
</isNotEmpty>
<isNotEmpty property="qsellingPoints" prepend="and">
	upper(tab.sellingPoints) like upper('%$qsellingPoints$%')
</isNotEmpty>
<isNotEmpty property="order">
		$order$ 
</isNotEmpty>
<isEmpty property="order">
	 order by tab.launchDate desc,tab.Segment asc,tab.brandNameEn asc,tab.manfNameEn asc,tab.modelNameEn asc,tab.trimEn desc,tab.MSRP desc
</isEmpty>
			) a
	 ) t
	where 1=1
		<isNotEmpty property="start" prepend="and">
			t.rowIndex > $start$  and t.rowIndex <![CDATA[ <=  ]]> $limit$
		</isNotEmpty>

</select>
 
</sqlMap>