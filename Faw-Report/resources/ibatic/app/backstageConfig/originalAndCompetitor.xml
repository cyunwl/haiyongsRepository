<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="originalAndCompetitor">
<select id="getOriginalAndCompetitorData" resultClass="com.ways.app.backstageConfig.model.OriginalAndCompetitor">
select e.manf_name_cn     bpManfName,
       e.bp_model_id      bpSubModelId,
       e.submodel_name_cn bpSubModelName,
       e.bp_model_sort    bpSubModelSort,
       f.manf_name_cn     jpManfName,
       f.jp_model_id      jpSubModelId,
       f.submodel_name_cn jpSubModelName,
       f.jp_model_sort    jpSubModelSort
  from (select distinct a.bp_model_id, b.manf_name_cn, c.submodel_name_cn, a.bp_model_sort
          from fdm_car_bp_jp a, fdm_car_manf b, fdm_car_submodel c
         where a.bp_model_id = c.submodel_id
           and a.bp_manf_id = b.manf_id) e
  left join (select distinct a.bp_model_id,
                             a.jp_model_id,
                             b.manf_name_cn,
                             c.submodel_name_cn,
                             a.jp_model_sort
               from fdm_car_bp_jp a, fdm_car_manf b, fdm_car_submodel c
              where a.jp_model_id = c.submodel_id
                and a.jp_manf_id = b.manf_id) f
    on e.bp_model_id = f.bp_model_id
    where 1=1
      <isNotEmpty property="bpManfName">
       and regexp_like(e.manf_name_cn, '$bpManfName$', 'i')
      </isNotEmpty>
      <isNotEmpty property="bpSubModelId">
       and f.bp_model_id = $bpSubModelId$
       </isNotEmpty>
      <isNotEmpty property="bpSubModelName">
       and regexp_like(e.submodel_name_cn, '$bpSubModelName$', 'i')
       </isNotEmpty>
      <isNotEmpty property="jpManfName">
       and regexp_like(f.manf_name_cn, '$jpManfName$', 'i')
       </isNotEmpty>
      <isNotEmpty property="jpSubModelName">
       and regexp_like(f.submodel_name_cn, '$jpSubModelName$', 'i')
      </isNotEmpty> 
 order by e.bp_model_sort, f.jp_model_sort
</select>

<!-- 根据条件获取有效车型公共SQL -->
<sql id="getSubModel">
	 Select Distinct p.subModel_id SubModelId
      From v_Segment_Model o
     Inner Join Fdm_Segment Gr On o.Group_Id = Gr.Group_Id And o.Segment_Id = Gr.Segment_Id
     Inner Join Fdm_Car_Submodel p On o.Model_Id = p.Model_Id
     Inner Join Fdm_Car_Brand y On p.Brand_Id = y.Brand_Id
     Inner Join fdm_car_orig orig On y.orig_id = orig.orig_id
     Inner Join Fdm_Car_Manf u On p.Manf_Id = u.Manf_Id
     Inner Join Fdm_Car_Port_Type Cci On u.Port_Type_Id = Cci.Port_Type_Id
     Inner Join Fdm_Car_Version n On p.SubModel_Id = n.SubModel_Id
     Inner Join Fdm_Faw_Body_Type t On p.subModel_id = t.subModel_id
</sql>

<sql id="getUserGroupGradeSubModel">
	with t1 as(
		select d.*
			  from (Select Distinct g.Segment_Id grade_id,
					                g.Segment_Name_Cn grade_name_cn,
					                g.Segment_Parent_Id parent_id,
					                c.SubModel_Id subModelId,
					                c.SubModel_Name_Cn subModelName,
					                s.Port_Type_Id car_in,
					                s.Manf_Id manfId,
					                s.Manf_Name_Cn manfName,
					                p.Brand_Id brandId,
					                p.Brand_Name_Cn brandName,
					                Upper(getletter(substr(p.Brand_Name_Cn, 0, 1))) brandLetter,
					                Upper(getletter(substr(s.Manf_Name_Cn, 0, 1))) manfLetter
					  From Fdm_Segment g
					 Inner Join v_Segment_Model i  On g.Segment_Id = i.Segment_Id
					 Inner Join Fdm_Car_Model b    On b.Model_Id = i.Model_Id
					 Inner Join Fdm_Car_Submodel c On c.Model_Id = b.Model_Id
					 Inner Join Fdm_Car_Manf s     On s.Manf_Id = c.Manf_Id
					 Inner Join Fdm_Car_Brand p    On p.Brand_Id = c.Brand_Id
			  ) d
			 ,(
			 		<include refid="getSubModel"/>
			  ) c 
			  Where c.subModelId = d.subModelId
	)
</sql>

<!-- 获取品牌下子车型关系 -->
<resultMap class="com.ways.app.backstageConfig.model.SubModel" id="getSubModelByBrandGroup3">
	<result property="subModelId" column="subModelId" nullValue="" />
	<result property="subModelName" column="subModelName" nullValue="" />
	<result property="pooAttributeId" column="car_in" nullValue="" />
</resultMap>
<resultMap class="com.ways.app.backstageConfig.model.Brand" id="getSubModelByBrandGroup2" groupBy="brandId">
	<result property="brandId" column="brandId" nullValue="" />
	<result property="brandName" column="brandName" nullValue="" />
	<result property="subModelList" resultMap="commonGroup.getSubModelByBrandGroup3" />
</resultMap>
<resultMap class="com.ways.app.backstageConfig.model.LetterObj" id="getSubModelByBrandGroup1" groupBy="letter">
	<result property="letter" column="brandletter" nullValue="" />
	<result property="objList" resultMap="commonGroup.getSubModelByBrandGroup2" />
</resultMap>
<select id="getSubModelByBrand" resultMap="getSubModelByBrandGroup1">

	<include refid="getUserGroupGradeSubModel"/>			
	select * from t1 order by t1.brandletter,t1.brandId,t1.submodelid
</select>

<!-- 获取厂商 下子车型关系 -->
<resultMap class="com.ways.app.backstageConfig.model.SubModel" id="getSubModelByManfGroup3">
	<result property="subModelId" column="subModelId" nullValue="" />
	<result property="subModelName" column="subModelName" nullValue="" />
	<result property="pooAttributeId" column="car_in" nullValue="" />
</resultMap>
<resultMap class="com.ways.app.backstageConfig.model.Manf" id="getSubModelByManfGroup2" groupBy="manfId">
	<result property="manfId" column="manfId" nullValue="" />
	<result property="manfName" column="manfName" nullValue="" />
	<result property="subModelList" resultMap="commonGroup.getSubModelByManfGroup3" />
</resultMap>
<resultMap class="com.ways.app.backstageConfig.model.LetterObj" id="getSubModelByManfGroup1" groupBy="letter">
	<result property="letter" column="manfLetter" nullValue="" />
	<result property="objList" resultMap="commonGroup.getSubModelByManfGroup2" />
</resultMap>
<select id="getSubModelByManf" resultMap="getSubModelByManfGroup1">
	<include refid="getUserGroupGradeSubModel"/>		
	select * from t1 order by t1.manfletter,t1.manfid,t1.submodelid
</select>

<!-- 删除本竞品 -->
<delete id="deleteOriginalAndCompetitor">
	delete from fdm_car_bp_jp t where t.bp_model_id = '$bpSubModelId$'
	   and t.bp_model_sort = $bpSubModelSort$
</delete>

<!-- 添加本竞品 通过导入文件数据方式-->
<insert id="addOriginalAndCompetitorByImport">
  <![CDATA[
   insert into fdm_car_bp_jp(id, group_id, bp_manf_id, bp_model_segment_id, bp_model_id, bp_model_sort, jp_manf_id, jp_model_id, jp_model_sort) 
      select sys_guid(), 2, (select manf_id from fdm_car_submodel where submodel_name_cn = '$bpSubModelName$'), m.segment_id, m.model_id, $bpSubModelSort$,
   		(select f.manf_id from fdm_car_manf f where f.manf_name_cn = '$jpManfName$'),
   		(select v.submodel_id from fdm_car_submodel v where v.submodel_name_cn = '$jpSubModelName$'),
   		$jpSubModelSort$ 
      		from v_segment_model m, fdm_car_submodel t 
      			where t.submodel_id = m.model_id and t.submodel_name_cn = '$bpSubModelName$'
  ]]>
</insert>

<!-- 添加本竞品 通过页面新增方式-->
<insert id="addOriginalAndCompetitorByAdd">
  <![CDATA[
   insert into fdm_car_bp_jp select sys_guid(), 2, v.segment_id, (select manf_id from fdm_car_submodel where submodel_id = $bpSubModelId$), 
       $bpSubModelId$, m.manf_id, m.submodel_id, $jpSubModelSort$, $bpSubModelSort$ 
         from v_segment_model v, fdm_car_submodel m where m.submodel_id = $jpSubModelId$ and v.model_id = 
           (select model_id from fdm_car_submodel where subModel_id = $bpSubModelId$) 
  ]]>
</insert>

<!-- 修改本竞品组 -->
<delete id="deleteOriginalAndCompetitorByUpdate">
	delete from fdm_car_bp_jp t where t.bp_model_id = $bpSubModelId$ and t.bp_model_sort = $oldSort$
</delete>
<insert id="addOriginalAndCompetitorByUpdate">
	insert into fdm_car_bp_jp select sys_guid(), 2, v.segment_id, (select manf_id from fdm_car_submodel where submodel_id = $bpSubModelId$), 
	   $bpSubModelId$, m.manf_id, m.submodel_id, $jpSubModelSort$, $bpSubModelSort$ 
          from v_segment_model v, fdm_car_submodel m where m.submodel_id = $jpSubModelId$ and v.model_id = 
          (select model_id from fdm_car_submodel where subModel_id =  $bpSubModelId$ )
         
</insert>

<!-- 更新本竞品的车型排序 -->
<update id="updateOriginalAndCompetitorBpSort">
     update fdm_car_bp_jp set bp_model_sort = $bpNewSort$ where bp_model_id = $bpSubModelId$ and bp_model_sort = $bpSubModelSort$
</update>
<update id="updateOriginalAndCompetitorJpSort">
    update fdm_car_bp_jp set jp_model_sort = $jpNewSort$ where jp_model_id = $jpSubModelId$ and bp_model_id = $bpSubModelId$
</update>
</sqlMap>